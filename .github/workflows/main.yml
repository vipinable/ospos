name: ospos master pipeline

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      
      # Runs a set of commands using the runners shell
      - name: Build and Deploy
        env: 
           SSH_PVTKEY: ${{ secrets.SSH_PVTKEY }}
           VAULT_PASS: ${{ secrets.VAULT_PASS }}
           ANSIBLE_VAULT_PASSWORD_FILE: ~/.vault_pass.txt
           ANSIBLE_PRIVATE_KEY_FILE: ~/.private.key
           ANSIBLE_REMOTE_USER: ${{ secrets.SSH_USER }}
        run: |
          python3 -m venv /tmp/py3
          source /tmp/py3/bin/activate
          pip install --upgrade pip 
          pip install 'ansible==2.9'
          ansible --version
          #curl https://releases.hashicorp.com/terraform/1.2.2/terraform_1.2.2_linux_amd64.zip -o terraform_1.2.2_linux_amd64.zip
          #unzip terraform_1.2.2_linux_amd64.zip
          #./terraform --version
          echo ${VAULT_PASS} > ~/.vault_pass.txt
          echo ${SSH_PVTKEY} > ~/.private.key && chmod 600 ~/.private.key
          env ; ls -l; cat  ~/.private.key ; cat ~/.vault_pass.txt
          ansible all -i 129.213.115.117, -m ping 
