- hosts: all
  gather_facts: False
  user: nvipin
  become: yes
  vars:
    mysql_root_password: 'xxxxxxxxxx'
    mysql_admin_pass: 'xxxxxxx'
    encrypt_key: 'xxxxxxxxxxxx'
  
  tasks:
  - name: Install MariaDB server
    package:
      name: mariadb-server
      state: present
      update_cache: yes

  - name: Install Apache Web Server
    package:
      name: apache2
      state: present
      update_cache: yes
      
  - name: Install prerequsites packages
    package:
      name: '{{ item }}'
      state: present
    with_items:
    - expect
    - unzip

  - name: Install PHP and dependencies
    package: 
      name: '{{ item }}'
      state: present 
      update_cache: yes
    with_items:
    - phpmyadmin
    - php-curl
    - php-bcmath
    - php-intl
    - php-mbstring
    - php-gd

  - name: Secure MariaDB Installation
    script: mysql_secure.sh 'P0$adm!n' 'P0$adm!n'

  - name: Deploy the application
    unarchive: 
      src: opensourcepos.20210101114640.3.3.3.8e52bd.zip
      dest: /var/www/html
      owner: www-data 
      group: www-data

  - name: Configure App
    template:
      src: '{{ item }}.j2'
      dest: '/var/www/html/application/config/{{ item }}'
    with_items:
    - database.php
    - config.php

  - name: Set file permissions
    file:
      dest: '{{ item.name }}'
      mode: '{{ item.mode }}'
    with_items:
    - { name: '/var/www/html/application/logs', mode: '0750' }
    - { name: '/var/www/html/public/uploads', mode: '0750' }
    - { name: '/var/www/html/public/uploads/item_pics', mode: '0750' }
    - { name: '/var/www/html/import_customers.csv', mode: '0640' }

  - name: Configure firewall
    copy:
      src: rules.v4
      dest: /etc/iptables
    notify:
    - restartIptables
  - name: Configure htaccess
    copy:
      src: htaccess
      dest: /var/www/html/public/.htaccess
    notify:
    - restartApache

  - name: Configure Apache
    copy:
      src: apache2.conf
      dest: /etc/apache2/apache2.conf
    notify:
    - restartApache

  - name: enabled mod_rewrite
    apache2_module:
      name: rewrite
      state: present
    notify:
    - restartApache

  - name: Configure DB and Admin User
    shell: mysql -u root -e "CREATE SCHEMA ospos;CREATE USER 'admin'@'%' IDENTIFIED BY '{{ mysql_admin_pass }}';GRANT ALL PRIVILEGES ON ospos . * TO 'admin'@'%' IDENTIFIED BY '{{ mysql_admin_pass }}' WITH GRANT OPTION;FLUSH PRIVILEGES;"
    ignore_errors: True

  - name: Create tables
    shell: mysql -u admin -p{{ mysql_admin_pass }} -D ospos < /var/www/html/database/database.sql
    ignore_errors: True

  handlers:
  - name: restartIptables
    service:
      name: iptables
      state: reloaded
  - name: restartApache
    service:
      name: apache2
      state: restarted

